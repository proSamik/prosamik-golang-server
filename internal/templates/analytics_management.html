{{define "analytics-data-section"}}
    <!-- This template wraps both graph and table -->
    <div>
        {{template "analytics-graph" .}}
        {{template "analytics-table" .}}
    </div>
{{end}}

{{define "analytics-management"}}
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">Page Analytics</h2>

        <!-- Date Range Filter -->
        <div class="mb-6 flex gap-4">
            <div class="flex-1">
                <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">
                    Start Date
                </label>
                <input
                        type="date"
                        id="start-date"
                        name="startDate"
                        value="{{.Data.StartDate}}"
                        hx-get="/analytics/filter"
                        hx-trigger="change"
                        hx-include="#end-date"
                        hx-target="#analytics-data-section"
                        class="w-full p-2 border border-gray-300 rounded"
                >
            </div>
            <div class="flex-1">
                <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">
                    End Date
                </label>
                <input
                        type="date"
                        id="end-date"
                        name="endDate"
                        value="{{.Data.EndDate}}"
                        hx-get="/analytics/filter"
                        hx-trigger="change"
                        hx-include="#start-date"
                        hx-target="#analytics-data-section"
                        class="w-full p-2 border border-gray-300 rounded"
                >
            </div>
        </div>

        <!-- Analytics Content Section -->
        <div id="analytics-data-section">
            {{template "analytics-data-section" .}}
        </div>
    </div>
{{end}}

{{define "analytics-graph"}}
    <div class="bg-white p-4 rounded-lg border border-gray-200">
        <h3 class="text-lg font-semibold mb-4">Traffic Overview</h3>

        <!-- Interactive Chart -->
        <div id="graph-container" class="w-full min-h-[400px]">
            {{if not .Data.Stats}}
                <div class="text-center py-8 text-gray-500">
                    No data to display
                </div>
            {{else}}
                {{.Data.ChartHTML | safeHTML}}
            {{end}}
        </div>
    </div>
{{end}}

{{define "analytics-table"}}
    <div class="mt-8">
        <h3 class="text-lg font-semibold mb-4">Detailed Analytics</h3>
        {{$data := . }}
        {{if .Data}}
            {{$data = .Data}}
        {{end}}

        {{if not $data.Stats}}
            <div class="text-center py-8 text-gray-500">
                No analytics data available for the selected date range
            </div>
        {{else}}
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-300">
                    <thead>
                    <tr class="bg-gray-100">
                        <th scope="col" class="py-2 px-4 border-b text-left">Date</th>
                        <th scope="col" class="py-2 px-4 border-b text-right">Home</th>
                        <th scope="col" class="py-2 px-4 border-b text-right">About</th>
                        <th scope="col" class="py-2 px-4 border-b text-right">Blogs</th>
                        <th scope="col" class="py-2 px-4 border-b text-right">Projects</th>
                        <th scope="col" class="py-2 px-4 border-b text-right">Feedback</th>
                        <th scope="col" class="py-2 px-4 border-b text-right">Total</th>
                    </tr>
                    </thead>
                    <tbody>
                    {{/* Initialize grand totals */}}
                    {{$grandTotalHome := 0}}
                    {{$grandTotalAbout := 0}}
                    {{$grandTotalBlogs := 0}}
                    {{$grandTotalProjects := 0}}
                    {{$grandTotalFeedback := 0}}
                    {{$grandTotal := 0}}

                    {{range $date, $pageStats := $data.Stats}}
                        {{$total := 0}}
                        {{$total = add (index $pageStats "home") (index $pageStats "about")}}
                        {{$total = add $total (index $pageStats "blogs")}}
                        {{$total = add $total (index $pageStats "projects")}}
                        {{$total = add $total (index $pageStats "feedback")}}

                        {{$grandTotalHome = add $grandTotalHome (index $pageStats "home")}}
                        {{$grandTotalAbout = add $grandTotalAbout (index $pageStats "about")}}
                        {{$grandTotalBlogs = add $grandTotalBlogs (index $pageStats "blogs")}}
                        {{$grandTotalProjects = add $grandTotalProjects (index $pageStats "projects")}}
                        {{$grandTotalFeedback = add $grandTotalFeedback (index $pageStats "feedback")}}
                        {{$grandTotal = add $grandTotal $total}}

                        <tr class="hover:bg-gray-50">
                            <td class="py-2 px-4 border-b">{{formatDate $date}}</td>
                            <td class="py-2 px-4 border-b text-right">{{index $pageStats "home"}}</td>
                            <td class="py-2 px-4 border-b text-right">{{index $pageStats "about"}}</td>
                            <td class="py-2 px-4 border-b text-right">{{index $pageStats "blogs"}}</td>
                            <td class="py-2 px-4 border-b text-right">{{index $pageStats "projects"}}</td>
                            <td class="py-2 px-4 border-b text-right">{{index $pageStats "feedback"}}</td>
                            <td class="py-2 px-4 border-b text-right font-medium">{{$total}}</td>
                        </tr>
                    {{end}}
                    <!-- Grand Total Row -->
                    <tr class="bg-gray-50 font-semibold">
                        <td class="py-2 px-4 border-b">Total</td>
                        <td class="py-2 px-4 border-b text-right">{{$grandTotalHome}}</td>
                        <td class="py-2 px-4 border-b text-right">{{$grandTotalAbout}}</td>
                        <td class="py-2 px-4 border-b text-right">{{$grandTotalBlogs}}</td>
                        <td class="py-2 px-4 border-b text-right">{{$grandTotalProjects}}</td>
                        <td class="py-2 px-4 border-b text-right">{{$grandTotalFeedback}}</td>
                        <td class="py-2 px-4 border-b text-right">{{$grandTotal}}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        {{end}}
    </div>
{{end}}